<%= render 'layouts/map_js' %>

<script id="center_map" type="text/javascript" data-long=<%= center['longitude']%> data-lat=<%= center['latitude']%> >
  function initialize() {
    
    console.log("map center:", <%= center['latitude'] %>, <%= center['longitude'] %>);
    
    var script = document.getElementById("center_map");
    var data_lat = script.getAttribute('data-lat');
    var data_long = script.getAttribute('data-long');
    
    var mapOptions = {
      center: new google.maps.LatLng(data_lat, data_long),
      zoom: 14
    };
    
    var map = new google.maps.Map(document.getElementById("map-canvas"),
        mapOptions);  
        
    <% businesses.each do |business| %>    
  
      var bizLat = <%= business.location.coordinates['latitude'] %>;
    
      var bizLng = <%= business.location.coordinates['longitude'] %>;
            
      var marker = new google.maps.Marker({
          position: new google.maps.LatLng(bizLat, bizLng),
          map: map,
          title: "biz-<%= business.id %>"
      });
    
      var infowindow = new google.maps.InfoWindow();
      
      var html = "<a href='#biz-<%= business.id %>' class='marker-link' data-id='<%= business.id %>'><div class='map-info'><strong><%= business.name %></strong><br><%= business.location.display_address %></a>";
    
      bindInfoWindow(marker, map, infowindow, html);
    
    <% end %>
  }
  
  function bindInfoWindow(marker, map, infowindow, html) {
    google.maps.event.addListener(marker, 'click', function() {      
      infowindow.setContent(html);
      infowindow.open(map, marker);
    });
  } 
  
  google.maps.event.addDomListener(window, 'load', initialize);
  
</script>